name: ðŸ” Terraform Drift Detection (GCB)

on:
  schedule:
    - cron: '0 6 * * *'  # Run daily at 6 AM UTC
  workflow_dispatch:  # Allow manual trigger
    inputs:
      target:
        description: 'Specific environment/account (empty for all)'
        required: false
        type: string
      aws_region:
        description: 'AWS Region'
        required: false
        default: 'us-east-2'
        type: string

env:
  TF_VERSION: '1.6.0'
  TARGETS_DIR: 'environments'

jobs:
  discover:
    name: 'Discover Environments'
    runs-on: ubuntu-latest
    outputs:
      target_array: ${{ steps.get-targets.outputs.target_array }}
      target_count: ${{ steps.get-targets.outputs.target_count }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Discover environment directories
      id: get-targets
      run: |
        echo "ðŸ” Discovering environments in $TARGETS_DIR..."

        # Si se especificÃ³ un target especÃ­fico, usarlo
        if [ -n "${{ github.event.inputs.target }}" ]; then
          TARGET="${{ github.event.inputs.target }}"
          echo "ðŸŽ¯ Using specific target: $TARGET"

          # Verificar que el directorio existe
          if [ ! -d "$TARGETS_DIR/$TARGET" ]; then
            echo "âŒ Error: Directory $TARGETS_DIR/$TARGET does not exist"
            exit 1
          fi

          echo "target_array=[\"$TARGET\"]" >> $GITHUB_OUTPUT
          echo "target_count=1" >> $GITHUB_OUTPUT
        else
          # Descubrir todos los directorios en environments/
          echo "ðŸ” Scanning all directories in $TARGETS_DIR/"

          # Listar directorios (excluir archivos)
          TARGETS=$(find $TARGETS_DIR -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | sort | jq -R -s -c 'split("\n")[:-1]')

          # Contar targets
          COUNT=$(echo "$TARGETS" | jq 'length')

          echo "target_array=$TARGETS" >> $GITHUB_OUTPUT
          echo "target_count=$COUNT" >> $GITHUB_OUTPUT

          echo "ðŸ“‹ Discovered $COUNT environment(s):"
          echo "$TARGETS" | jq -r '.[]' | while read -r env; do
            echo "  - $env"
          done
        fi

  drift-detection:
    name: 'Drift: ${{ matrix.target }}'
    runs-on: ubuntu-latest
    needs: discover

    # Solo ejecutar si hay targets descubiertos
    if: needs.discover.outputs.target_count > 0

    environment: production

    permissions:
      contents: read
      issues: write

    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJson(needs.discover.outputs.target_array) }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ github.event.inputs.aws_region || 'us-east-2' }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Terraform Drift Detection
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        TARGET: ${{ matrix.target }}
        AWS_REGION: ${{ github.event.inputs.aws_region || 'us-east-2' }}
      run: |
        set -e

        echo "======================================================"
        echo "ðŸš€ Processing environment: $TARGET"
        echo "ðŸ“ Primary Region: $AWS_REGION"
        echo "======================================================"

        WORK_DIR="$TARGETS_DIR/$TARGET"

        # Verificar que el directorio existe
        if [ ! -d "$WORK_DIR" ]; then
          echo "âŒ Error: Directory $WORK_DIR does not exist"
          exit 1
        fi

        cd "$WORK_DIR"

        # Verificar que hay archivos .tf
        if ! ls *.tf 1> /dev/null 2>&1; then
          echo "âš ï¸ Warning: No .tf files found in $WORK_DIR, skipping..."
          exit 0
        fi

        echo "ðŸ“‚ Working directory: $(pwd)"
        echo "ðŸ“„ Terraform files found:"
        ls -1 *.tf
        echo ""

        # Detectar providers y regiones configuradas
        echo "ðŸ” Detecting configured AWS providers and regions..."
        REGIONS_DETECTED=""
        if [ -f "provider.tf" ]; then
          REGIONS_DETECTED=$(grep -E '^\s*region\s*=' provider.tf | sed 's/.*=\s*"\([^"]*\)".*/\1/' | sort -u | tr '\n' ', ' | sed 's/,$//')
          if [ -n "$REGIONS_DETECTED" ]; then
            echo "ðŸ“ Detected regions: $REGIONS_DETECTED"
          else
            REGIONS_DETECTED="$AWS_REGION"
          fi
        else
          REGIONS_DETECTED="$AWS_REGION"
        fi
        echo ""

        # Inicializar Terraform (con manejo de errores)
        echo "ðŸ”§ Initializing Terraform..."
        set +e  # Temporalmente permitir errores
        INIT_OUTPUT=$(terraform init -upgrade 2>&1)
        INIT_EXIT_CODE=$?
        set -e  # Reactivar modo estricto

        echo "$INIT_OUTPUT"

        if [ $INIT_EXIT_CODE -ne 0 ]; then
          echo ""
          echo "âŒ Terraform init failed with exit code: $INIT_EXIT_CODE"
          echo ""

          # Verificar si es un error de validaciÃ³n de variables
          if echo "$INIT_OUTPUT" | grep -q "Invalid reference in variable validation"; then
            echo "âš ï¸  Configuration Error: Invalid variable validation detected"
            echo "ðŸ“ Creating issue to report configuration problem..."

            # Crear issue para reportar el error de configuraciÃ³n
            ERROR_HASH=$(echo -n "$INIT_OUTPUT" | sha256sum | cut -d' ' -f1 | head -c 8)
            ERROR_TITLE="Configuration Error in environment: ${TARGET} (${ERROR_HASH})"

            # Verificar si ya existe un issue para este error
            EXISTING_ERROR_ISSUE=$(gh issue list --state open --search "$ERROR_HASH in:title" --json title --jq '.[0].title // empty')

            if [ -z "$EXISTING_ERROR_ISSUE" ]; then
              ERROR_BODY="## Terraform Configuration Error\n\n"
              ERROR_BODY="${ERROR_BODY}**Environment:** \`${TARGET}\`\n"
              ERROR_BODY="${ERROR_BODY}**Region(s):** \`${REGIONS_DETECTED}\`\n"
              ERROR_BODY="${ERROR_BODY}**Detection Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n"
              ERROR_BODY="${ERROR_BODY}**Error Type:** Variable Validation Error\n"
              ERROR_BODY="${ERROR_BODY}**Workflow Run:** [View Details](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\n\n"
              ERROR_BODY="${ERROR_BODY}---\n\n## Error Details\n\n"
              ERROR_BODY="${ERROR_BODY}\`\`\`\n${INIT_OUTPUT}\n\`\`\`\n\n"
              ERROR_BODY="${ERROR_BODY}---\n\n**Resolution Required:**\n"
              ERROR_BODY="${ERROR_BODY}The Terraform configuration has validation errors that prevent initialization.\n"
              ERROR_BODY="${ERROR_BODY}Variable validations can only reference the variable itself, not other variables.\n\n"
              ERROR_BODY="${ERROR_BODY}**Common fix:** Remove cross-variable references in validation blocks and use \`precondition\` blocks in resources/modules instead."

              gh issue create \
                --title "$ERROR_TITLE" \
                --body "$ERROR_BODY" \
                --label "terraform,configuration-error,high-priority" 2>/dev/null || echo "âš ï¸  Could not create issue"

              echo "âœ… Configuration error issue created"
            else
              echo "ðŸ“Œ Configuration error already reported in existing issue"
            fi
          fi

          echo ""
          echo "â­ï¸  Skipping drift detection for this environment due to initialization failure"
          echo "======================================================"
          exit 0  # Exit gracefully to allow other environments to continue
        fi

        echo "âœ… Terraform initialized successfully"

        # Ejecutar plan con detailed-exitcode
        PLAN="plan_${TARGET}.tfplan"
        ISSUE_BODY="issue_body_${TARGET}.md"
        ec=0

        echo ""
        echo "ðŸ“Š Generating Terraform plan..."
        terraform plan -detailed-exitcode -out="$PLAN" 2>&1 || ec=$?

        echo "Exit code: $ec"
        echo ""

        case $ec in
          0)
            echo "âœ… No changes found in environment: $TARGET"
            echo "Infrastructure is in sync with Terraform configuration."
            ;;
          1)
            echo "âŒ Terraform plan command failed in environment: $TARGET"
            echo "This indicates an error in the Terraform configuration or state."
            exit 1
            ;;
          2)
            echo "âš ï¸  Drift detected in environment: $TARGET"
            echo "Infrastructure has diverged from Terraform configuration."
            echo ""

            # 1. Create issue body from plan
            echo "ðŸ“ Generating issue content..."
            echo '```diff' > "${ISSUE_BODY}"
            terraform show -no-color "${PLAN}" >> "${ISSUE_BODY}"
            echo '```' >> "${ISSUE_BODY}"

            # Formatear output para mejor legibilidad en GitHub
            sed -i -e 's/  +/+/g' -e 's/  ~/~/g' -e 's/  /-/' "${ISSUE_BODY}"
            MESSAGE=$(cat "${ISSUE_BODY}")

            # 2. Generate unique hash for the message
            UNIQUE_HASH=$(echo -n "${MESSAGE}" | sha256sum | cut -d' ' -f1 | head -c 8)
            ISSUE_TITLE="Drift detected in environment: ${TARGET} (${UNIQUE_HASH})"

            echo "ðŸ”‘ Hash: $UNIQUE_HASH"
            echo "ðŸ“‹ Title: $ISSUE_TITLE"
            echo ""

            # 3. Check if issue already exists with this hash
            echo "ðŸ” Checking if issue already exists for this drift..."
            EXISTING_ISSUE=$(gh issue list --state open --search "$UNIQUE_HASH in:title" --json title --jq '.[0].title // empty')

            if [ -n "$EXISTING_ISSUE" ]; then
              echo "âš ï¸  Drift was already detected previously."
              echo "ðŸ“Œ Existing issue found with hash: ${UNIQUE_HASH}"
              echo "ðŸ”— No new issue will be created to avoid duplicates."
            else
              echo "ðŸ“¬ Creating GitHub issue for environment '$TARGET'..."

              # Agregar metadata al cuerpo del issue
              FULL_MESSAGE="## Drift Detection Report"
              FULL_MESSAGE="${FULL_MESSAGE}\n\n**Environment:** \`${TARGET}\`"
              FULL_MESSAGE="${FULL_MESSAGE}\n**Region(s):** \`${REGIONS_DETECTED}\`"
              FULL_MESSAGE="${FULL_MESSAGE}\n**Detection Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              FULL_MESSAGE="${FULL_MESSAGE}\n**Repository:** ${GITHUB_REPOSITORY}"
              FULL_MESSAGE="${FULL_MESSAGE}\n**Workflow Run:** [View Details](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})"

              # Si hay mÃºltiples regiones, agregar nota
              if echo "$REGIONS_DETECTED" | grep -q ','; then
                FULL_MESSAGE="${FULL_MESSAGE}\n\n> **Note:** This environment has a multi-region deployment. Changes may affect resources across multiple regions."
              fi

              FULL_MESSAGE="${FULL_MESSAGE}\n\n---\n\n## Changes Detected\n\n${MESSAGE}\n\n---\n\n**Action Required:** Please review the changes and either:"
              FULL_MESSAGE="${FULL_MESSAGE}\n1. Apply the Terraform changes if they are expected"
              FULL_MESSAGE="${FULL_MESSAGE}\n2. Update the Terraform configuration if the infrastructure changes are correct"
              FULL_MESSAGE="${FULL_MESSAGE}\n3. Investigate and remediate any unauthorized changes"
              FULL_MESSAGE="${FULL_MESSAGE}\n\n**Note:** This issue will be automatically closed when the drift is resolved."

              ISSUE_URL=$(gh issue create \
                --title "$ISSUE_TITLE" \
                --body "$FULL_MESSAGE" 2>&1)

              if [ $? -eq 0 ]; then
                echo "âœ… Issue created successfully!"
                echo "ðŸ”— Issue URL: $ISSUE_URL"
                echo ""

                # Try to add labels if they exist (non-blocking)
                echo "ðŸ·ï¸  Attempting to add labels..."
                gh issue edit "$ISSUE_URL" --add-label "terraform,drift-detection,infrastructure" 2>/dev/null && echo "âœ… Labels added successfully" || echo "âš ï¸  Labels not added (may not exist in repo)"
              else
                echo "âŒ Error creating issue: $ISSUE_URL"
              fi
            fi
            echo ""

            # 4. Send Teams notification
            if [ -n "$TEAMS_WEBHOOK_URL" ]; then
              echo "ðŸ“¢ Sending Teams notification..."

              DETECTION_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
              WORKFLOW_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

              # Create Teams webhook payload using jq
              jq -n \
                --arg target "$TARGET" \
                --arg repo "$GITHUB_REPOSITORY" \
                --arg regions "$REGIONS_DETECTED" \
                --arg time "$DETECTION_TIME" \
                --arg url "$WORKFLOW_URL" \
                '{
                  "@type": "MessageCard",
                  "@context": "https://schema.org/extensions",
                  summary: "Terraform Drift Detected",
                  themeColor: "FF6B35",
                  title: "ðŸ” Terraform Drift Detected",
                  sections: [{
                    activityTitle: ("Infrastructure drift detected in **" + $target + "**"),
                    activitySubtitle: ("Project: " + $repo),
                    facts: [
                      {name: "Environment:", value: $target},
                      {name: "Region(s):", value: $regions},
                      {name: "Detection Time:", value: $time}
                    ],
                    markdown: true
                  }],
                  potentialAction: [{
                    "@type": "OpenUri",
                    name: "View Workflow Run",
                    targets: [{os: "default", uri: $url}]
                  }]
                }' > payload_teams.json

              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST -H "Content-Type: application/json" -d @payload_teams.json "$TEAMS_WEBHOOK_URL")
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

              if [ "$HTTP_CODE" -eq 200 ]; then
                echo "âœ… Teams notification sent successfully"
              else
                echo "âš ï¸  Error sending Teams notification (HTTP $HTTP_CODE)"
              fi
            else
              echo "â„¹ï¸  Teams webhook URL not configured, skipping notification."
            fi

            echo ""
            echo "::warning::Terraform drift detected in environment: $TARGET"
            ;;
        esac

        echo "======================================================"
        echo "âœ… Drift detection completed for environment: $TARGET"
        echo "======================================================"

  summary:
    name: 'Drift Detection Summary'
    runs-on: ubuntu-latest
    needs: [discover, drift-detection]
    if: always()

    steps:
    - name: Generate Summary
      run: |
        echo "# ðŸ” Terraform Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow Run:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Environments Scanned" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total:** ${{ needs.discover.outputs.target_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ needs.drift-detection.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.drift-detection.result }}" = "success" ]; then
          echo "âœ… All environments checked successfully. Check individual job logs for drift details." >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.drift-detection.result }}" = "failure" ]; then
          echo "âŒ Some environments failed. Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Drift detection completed with warnings or was skipped." >> $GITHUB_STEP_SUMMARY
        fi
